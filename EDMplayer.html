<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Audio Tool â€“ Recorder, Waveform, Spectrogram, Editor + Nightcore + Vocal Isolation</title>
<style>
    body {
        background:#0a0a0a;
        color:white;
        font-family: Arial, sans-serif;
        text-align:center;
        margin:0;
    }
    h1 { margin-top:20px; font-weight:300; }
    button {
        padding:10px 20px;
        margin:5px;
        background:#1a1a1a;
        border:1px solid #444;
        color:white;
        cursor:pointer;
        border-radius:5px;
    }
    button:hover { background:#333; }
    canvas {
        display:block;
        margin:20px auto;
        background:black;
        border-radius:10px;
    }
    .panel {
        width:80%;
        margin:20px auto;
        background:#111;
        padding:20px;
        border-radius:10px;
        text-align:left;
    }
    input[type="range"] { width:100%; }
</style>
</head>
<body>

<h1>ðŸŽ§ Audio Broker</h1>

<!-- CONTROLS -->
<div id="controls">
    <button id="startMic">Start Mic</button>
    <button id="record">Record</button>
    <button id="stop">Stop</button>
    <button id="play">Play</button>
    <button id="isolateVoice">Isolate Voice</button>
</div>

<!-- WAVEFORMS -->
<canvas id="sphericalWave" width="600" height="600"></canvas>
<canvas id="spectrogram" width="800" height="300"></canvas>

<!-- WAVEFORM TRIM EDITOR -->
<div class="panel">
    <h2>âœ‚ Waveform Editor</h2>
    <label>Trim Start:</label>
    <input type="range" id="trimStart" min="0" max="100" value="0">
    <label>Trim End:</label>
    <input type="range" id="trimEnd" min="0" max="100" value="100">
</div>

<!-- NIGHTCORE EDITOR -->
<div class="panel">
    <h2>ðŸŽµ Nightcore Editor</h2>

    <label>Pitch Shift (Semitones):</label>
    <input type="range" id="pitchShift" min="-12" max="12" value="4">

    <label>Speed / Tempo (1.0 = normal):</label>
    <input type="range" id="tempo" min="0.5" max="2" value="1.25" step="0.01">

    <button id="applyNightcore">Preview Nightcore</button>
</div>

<script>
/* ============================================
   AUDIO + MICROPHONE INITIALIZATION
=============================================== */
let audioContext, analyser, microphone, processor;
let dataArray;
let mediaRecorder, recordedChunks = [];
let audioBuffer = null;

document.getElementById("startMic").onclick = async () => {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    microphone = audioContext.createMediaStreamSource(stream);

    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;

    microphone.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);

    drawSphericalWave();
    drawSpectrogram();
};

/* ============================================
      RECORDING SYSTEM â€” FIXED & FULLY WORKING
=============================================== */
document.getElementById("record").onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    recordedChunks = [];

    mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);

    mediaRecorder.onstop = async () => {
        let blob = new Blob(recordedChunks, { type: "audio/webm" });
        let arrayBuffer = await blob.arrayBuffer();
        audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
    };

    mediaRecorder.start();
};

document.getElementById("stop").onclick = () => {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }
};

/* ============================================
      PLAY NORMAL AUDIO
=============================================== */
document.getElementById("play").onclick = () => {
    if (!audioBuffer) return alert("Record something first!");

    let trimmed = trimAudio(audioBuffer);

    let source = audioContext.createBufferSource();
    source.buffer = trimmed;
    source.connect(audioContext.destination);
    source.start();
};

/* ============================================
      TRIM EDITOR
=============================================== */
function trimAudio(buffer) {
    let start = document.getElementById("trimStart").value / 100 * buffer.duration;
    let end = document.getElementById("trimEnd").value / 100 * buffer.duration;

    if (end <= start) end = start + 0.01;

    let length = (end - start) * buffer.sampleRate;
    let newB = audioContext.createBuffer(1, length, buffer.sampleRate);

    let oldData = buffer.getChannelData(0);
    let newData = newB.getChannelData(0);

    newData.set(
        oldData.slice(
            Math.floor(start * buffer.sampleRate),
            Math.floor(end * buffer.sampleRate)
        )
    );

    return newB;
}

/* ============================================
      SPHERICAL WAVEFORM
=============================================== */
function drawSphericalWave() {
    requestAnimationFrame(drawSphericalWave);

    if (!analyser) return;

    const canvas = document.getElementById("sphericalWave");
    const ctx = canvas.getContext("2d");

    analyser.getByteTimeDomainData(dataArray);

    ctx.clearRect(0,0,canvas.width,canvas.height);

    const cx = canvas.width/2;
    const cy = canvas.height/2;
    const baseRadius = 150;

    ctx.beginPath();
    for (let i=0; i<dataArray.length; i++) {
        let angle = (i / dataArray.length) * Math.PI * 2;
        let amp = dataArray[i] / 128;
        let r = baseRadius + amp * 60;

        let x = cx + r * Math.cos(angle);
        let y = cy + r * Math.sin(angle);

        (i===0) ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.strokeStyle="cyan";
    ctx.lineWidth=2;
    ctx.stroke();
}

/* ============================================
      SPECTROGRAM
=============================================== */
function drawSpectrogram() {
    requestAnimationFrame(drawSpectrogram);

    if (!analyser) return;

    const canvas = document.getElementById("spectrogram");
    const ctx = canvas.getContext("2d");

    analyser.getByteFrequencyData(dataArray);

    let imgData = ctx.getImageData(1,0,canvas.width-1,canvas.height);
    ctx.putImageData(imgData,0,0);

    for (let i=0; i<dataArray.length; i++) {
        let v = dataArray[i];
        let y = canvas.height - (i / dataArray.length * canvas.height);
        ctx.fillStyle = `rgb(${v}, ${v/2}, 255)`;
        ctx.fillRect(canvas.width-1, y, 1, 1);
    }
}

/* ============================================
      NIGHTCORE MODE
=============================================== */
document.getElementById("applyNightcore").onclick = () => {
    if (!audioBuffer) return alert("Record first!");

    let trimmed = trimAudio(audioBuffer);

    let pitch = document.getElementById("pitchShift").value;
    let tempo = document.getElementById("tempo").value;

    let source = audioContext.createBufferSource();
    source.buffer = trimmed;

    source.playbackRate.value = tempo;
    source.detune.value = pitch * 100;

    source.connect(audioContext.destination);
    source.start();
};

/* ============================================
      VOICE ISOLATION (CENTER CHANNEL REMOVAL)
=============================================== */
document.getElementById("isolateVoice").onclick = () => {
    if (!audioBuffer) return alert("Record first!");

    let source = audioContext.createBufferSource();
    source.buffer = audioBuffer;

    // Create filters for voice isolation (band-pass)
    let bandpass = audioContext.createBiquadFilter();
    bandpass.type = "bandpass";
    bandpass.frequency.value = 1500;  // Vocal center
    bandpass.Q.value = 1;

    source.connect(bandpass);
    bandpass.connect(audioContext.destination);

    source.start();
};

</script>
</body>
</html>
